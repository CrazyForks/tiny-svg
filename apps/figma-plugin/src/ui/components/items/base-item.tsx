import { type ReactNode, useEffect, useState } from "react";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/ui/components/base/select";
import { generateThumbnail } from "@/ui/lib/thumbnail";
import { thumbnailCache } from "@/ui/lib/thumbnail-cache";
import type { SvgItem } from "@/ui/store/plugin-store";
import { usePluginStore } from "@/ui/store/plugin-store";

interface BaseItemProps {
  item: SvgItem;
  showPresetSelector?: boolean;
  actions: ReactNode;
  onThumbnailClick?: () => void;
}

export function BaseItem({
  item,
  showPresetSelector = true,
  actions,
  onThumbnailClick,
}: BaseItemProps) {
  const [thumbnail, setThumbnail] = useState<string>();
  const [isLoadingThumbnail, setIsLoadingThumbnail] = useState(true);

  const { presets, updateItem } = usePluginStore();

  // Generate thumbnail
  useEffect(() => {
    const cached = thumbnailCache.get(item.id);
    if (cached) {
      setThumbnail(cached);
      setIsLoadingThumbnail(false);
    } else {
      setIsLoadingThumbnail(true);
      const svg = item.compressedSvg || item.originalSvg;
      generateThumbnail(svg, 48)
        .then((url) => {
          thumbnailCache.set(item.id, url);
          setThumbnail(url);
        })
        .catch((error) => {
          console.error("Failed to generate thumbnail:", error);
        })
        .finally(() => {
          setIsLoadingThumbnail(false);
        });
    }
  }, [item.id, item.compressedSvg, item.originalSvg]);

  const handlePresetChange = (presetId: string) => {
    updateItem(item.id, { preset: presetId });
  };

  const formatSize = (bytes: number | undefined): string => {
    if (!bytes) {
      return "-";
    }
    if (bytes < 1024) {
      return `${bytes}B`;
    }
    if (bytes < 1024 * 1024) {
      return `${(bytes / 1024).toFixed(1)}KB`;
    }
    return `${(bytes / (1024 * 1024)).toFixed(1)}MB`;
  };

  const formatCompressionRatio = (ratio: number | undefined): string => {
    if (!ratio) {
      return "";
    }
    return `(-${Math.round(ratio * 100)}%)`;
  };

  const renderThumbnail = () => {
    if (isLoadingThumbnail) {
      return <div className="thumbnail-skeleton" />;
    }
    if (thumbnail) {
      return (
        <img
          alt={item.name}
          className="thumbnail"
          height={48}
          src={thumbnail}
          width={48}
        />
      );
    }
    return <div className="thumbnail-placeholder">?</div>;
  };

  return (
    <div className="base-item">
      <button
        aria-label={`Preview ${item.name}`}
        className="thumbnail-button"
        onClick={onThumbnailClick}
        type="button"
      >
        {renderThumbnail()}
      </button>

      <div className="flex min-w-0 flex-1 flex-col gap-1">
        <div className="truncate font-medium text-base" title={item.name}>
          {item.name}
        </div>

        {showPresetSelector && (
          <Select onValueChange={handlePresetChange} value={item.preset}>
            <SelectTrigger
              className="w-fit"
              onClick={(e) => e.stopPropagation()}
              size="sm"
            >
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="inherit">Inherit</SelectItem>
              {presets.map((preset) => (
                <SelectItem key={preset.id} value={preset.id}>
                  {preset.name}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        )}

        <div className="text-muted-foreground text-xs">
          {item.compressedSize ? (
            <>
              <span className="line-through opacity-70">
                {formatSize(item.originalSize)}
              </span>
              {" â†’ "}
              <span className="font-medium text-foreground">
                {formatSize(item.compressedSize)}
              </span>{" "}
              <span className="font-semibold text-success">
                {formatCompressionRatio(item.compressionRatio)}
              </span>
            </>
          ) : (
            <span>{formatSize(item.originalSize)}</span>
          )}
        </div>
      </div>

      <div className="flex gap-1">{actions}</div>
    </div>
  );
}
